#include <stdio.h>
#include <fcntl.h> 
#include <io.h>   
#include <stdlib.h>
#include <string.h>
#include <codecvt> 
#include <fstream>
#include<wchar.h>

using namespace std;

typedef struct SinhVien
{
	wchar_t mssv[20];
	wchar_t hoten[30];
	wchar_t major[30];
	int khoa;
	wchar_t birth[20];
	wchar_t JPG[100];
	wchar_t desc[1000];
	wchar_t hobby[10][200];
	int x;
}SV;
int demnguoi(FILE* fin)
{
	int dem = 0;
	wchar_t c;
	while (feof(fin)) 
	{
		c = fgetwc(fin);
		if (c == L'\n')
			dem++;

	}
	return dem;
}
void tachkhoahoc(FILE* fin, int &s){
	fseek(fin, 2L, SEEK_CUR);
	fwscanf(fin, L"%d", &s);
	fseek(fin, 1L, SEEK_CUR);
	
}
void tachnoidung(FILE* fin, wchar_t noidung[]){
	int i = 0;
	wchar_t c;
	fseek(fin, 2L, SEEK_CUR);
	while (1){
		c = fgetwc(fin);
		if (c == L'"' || c == L'\n'||c == EOF)
			break;
		else{
			noidung[i] = c;
			i++;
		}
	}
	noidung[i] = '\0';
}
int demsothich(FILE*fin){
	int dem = 0;
	wchar_t c;
	while (1){
		c = fgetwc(fin);
		if (c == L'"')
			dem++;
		if (c == '\n'||c == EOF)
			break;
	}
	return (dem / 2) - 7;
}
void sothichmoinguoi(FILE* fin, SV sv[10])
{
	for (int i = 0; i < 3; i++)
	{
		sv[i].x = demsothich(fin);
	}
	rewind(fin);
}
void GanNoiDung(FILE* fin, SV &sv){
	int i;
	
	tachnoidung(fin, sv.mssv);
	tachnoidung(fin, sv.hoten);
	tachnoidung(fin, sv.major);
	tachkhoahoc(fin, sv.khoa);
	tachnoidung(fin, sv.birth);
	tachnoidung(fin, sv.JPG);
	tachnoidung(fin, sv.desc);
	for (i = 0; i < sv.x; i++){
		tachnoidung(fin, sv.hobby[i]);
	}
}
wchar_t* duongdanhtml(SV sv)
{
	wchar_t tenweb[50] = L"Websites\\";
	wchar_t duoifile[50] = L".html";
	wcscat(tenweb, sv.mssv);
	wcscat(tenweb, duoifile);
	return tenweb;
}
//wchar_t* chenvao(wchar_t cantim[], wchar_t chuoicha[], wchar_t chuoichen[]){
//	wchar_t gep1[300];
//	wchar_t* gep2;
//	gep2 = wcsstr(chuoicha, cantim);
//	int n = wcslen(chuoicha) - wcslen(gep2);
//	wcsncpy(gep1, chuoicha, n);
//	gep1[n] = L'\0';
//	wcscat(chuoichen, gep2 + wcslen(cantim));
//	wcscat(gep1, chuoichen);
//	return gep1;
//}
void chenvao(wchar_t cantim[], wchar_t chuoicha[], wchar_t chuoichen[]){
	wchar_t gep1[200];
	wchar_t* gep2;
	chuoicha = wcsstr(chuoicha, cantim);
	int n = wcslen(chuoicha) - wcslen(chuoicha);
	wcsncpy(gep1, chuoicha, n);
	gep1[n] = L'\0';
	wcscat(chuoichen, chuoicha + wcslen(cantim));
	wcscat(gep1, chuoichen);
	wcscpy(chuoicha, gep1);
	
}
void chenso(wchar_t cantim[], wchar_t chuoicha[], int so){

}
void timvachen(wchar_t c[],SV sv){
	wchar_t*e,*f,*g,*h,*k,*i,*l,*m;
	wchar_t tenhoa[30] = L"NGUYỄN VĂN A";
	wchar_t ten[30] = L"Nguyễn Văn A";
	wchar_t mssv[10] = L"1212123";
	wchar_t major[30]=L"Công nghệ thông tin";
	wchar_t khoa[10] = L"2012";
	wchar_t birth[20]=L"20/01/1994";
	wchar_t JPG[100]=L"HinhCaNhan.jpg";
	wchar_t desc[1000]=L"Tôi là một người rất thân thiện.";
	wchar_t hobby1[100]=L"Âm nhạc: POP, Balad";
	wchar_t hobby2[100] =L"Ẩm thực: bún riêu, bún thịt nướng";
	e = wcsstr(c, ten);
	if (e != 0){
		chenvao(ten, c, sv.hoten);
	}
	m = wcsstr(c, tenhoa);
	if (m != 0){
		chenvao(tenhoa, c, wcsupr(sv.hoten));
	}
	f = wcsstr(c, mssv);
	if (f != 0){
		chenvao(mssv, c, sv.mssv);
	}
	g = wcsstr(c, major);
	if (g != 0){
		chenvao(major, c, sv.major);
	}
	//h = wcsstr(c, khoa);
	//if (h != 0){
	//	chenvao(ten, c, sv.khoa);
	//}
	i = wcsstr(c, birth);
	if (i != 0){
		chenvao(birth, c, sv.birth);
	}
	k = wcsstr(c, JPG);
	if (k != 0){
		chenvao(JPG, c, sv.JPG);
	}
	l = wcsstr(c, desc);
	if (l != 0){
		chenvao(desc, c, sv.desc);
	}
}
void xuatnoidungvaohtml(FILE* fDefault, FILE*csv, SV &sv){
	rewind(fDefault);
	wchar_t c[500];
	while (!feof(fDefault)){
		fgetws(c, 500, fDefault);
		timvachen(c, sv);
		fputws(c, csv);
	}
	fclose(csv);
}
void main()
{
	_setmode(_fileno(stdout), _O_U16TEXT); 
	_setmode(_fileno(stdin), _O_U16TEXT);// hien tieng viet tren CMD
	SV sv[20];
	int soSV = 10, k;
	FILE *fin = _wfopen(L"ListSV.csv", L"r, ccs=UTF-8");
	if (!fin)
		wprintf(L"Không thể đọc file \n");
	else{
		sothichmoinguoi(fin, sv);
		fseek(fin, 1L, SEEK_CUR);
		for (k = 0; k < soSV; k++){
			fseek(fin, 1L, SEEK_CUR);
			GanNoiDung(fin, sv[k]);
		}
	}
	int i = 0;
	wchar_t *tenweb;
	FILE *fDefault = _wfopen(L"Default.html", L"r, ccs=UTF-8");
	if (!fDefault)
		wprintf(L"Không thể đọc .file \n");
	else{
		while (i < 10){

			tenweb = duongdanhtml(sv[i]);
			FILE *fweb = _wfopen(tenweb, L"wt, ccs=UTF-8");
			if (!fweb)
				wprintf(L"Không thể mở file \n");
			else
				xuatnoidungvaohtml(fDefault, fweb, sv[i]);
			i++;
		}
	}
	fclose(fin);
	
}
